---
- hosts: localhost
  become: true
  var_files:
      - /root/snipeit-ansible/vars/external_vars.yml
  handlers: 
      - /root/handlers/main.yml
  tasks:
    - name: Update apt repo and cache on ubuntu
      apt: update_cache=yes force_apt_get=yes cache_valid_time=3600

    - name: Upgrade all package on servers
      apt: upgrade=dist force_apt_get=yes

    - name: Universe repository is enabled or not
      apt_repository:
       repo: dep http://archive.ubuntu.com/ubuntu focal universe
       state: present
       update_cache: true 

    - name: Install Nginx and mysql
      apt: name={{ item }} update_cache=yes state=latest
      loop: [ 'nginx', 'mysql-server', 'php-fpm', 'php-mysql', 'python-mysqldb' ]

    - name: Insatll PHP
      apt: name={{ item }} state=present
      with_items:
           - php7.4-cli
	   - php7.4-curl
	   - php7.4-json
	   - php7.4-gd
	   - php7.4-mdstring
	   - php7.4-intl
	   - php7.4-bcmath
	   - php7.4-bz2
	   - php7.4-readline
	   - php7.4-fpm
	   - php7.4-zip
	   - php7.4-mysql
	   - php7.4-ldap
	   - php7.4-xml
	   - php7.4-tokenizer

    - name: Insatll composer
      shell: curl -sS https://getcomposer.org/installer | php

    - name: Move the composer.phar file 
      command: mv composer.phar /usr/local/bin/composer

    - name: Execute composer
      file:
        path: /usr/local/bin/composer
        mode: a+x
        state: file

    - name: create directory ansible 
      file: 
        path: /var/www/snipeit
        state: directory

    - name: Clone github repo
      git: 
       repo: https://github.com/snipe/snipe-it
       dest: /var/www/snipeit
       clone: yes
       update: yes
       force: yes

    - name: Create snipeit-database
      mysql_db: name={{ snipeit_dbname }} state=present
      register: db_status

    - name: Create snipeit-mysql-user
      mysql-user: name={{ snipeit_dbuser }} host='localhost' password={{ snipeit_dbuser_password }} priv=*.*:ALL state=present
      notify:
         - start mysql

    - name: Install snipeit | Copy and update .env file to snipeit-directory
      template:
         src: dotenv
         dest: /var/www/snipeit/.env

    - name: change mode for storage on snipeit
      file:
        path: /var/www/snipeit
        owner: www-data
        group: www-data
        mode: "0755"
        recurse: yes

    - name: change mode for storage on snipeit
      file:
        path: /var/www/snipeit/public/uploads
        owner: www-data
        group: www-data
        mode: "0755"
        recurse: yes

    - name: Enable new site
      template:
	src: snipeit.conf
	dest: /etc/nginx/sites-available/snipeit.com

    - name: Enable new site
      file: 
	src: /etc/nginx/sites-available/snipeit.com
	dest: /etc/nginx/sites-available/snipeit.com
	state: link
	force: yes
      notify:
	- restart nginx

    - name: Composer Installation	
      shell: composer update --lock
      args: 
	create: /var/www/snipeit

    - name: Composer Installation	
      shell: composer install
      args: 
	create: /var/www/snipeit

    - name: Install snipe-IT |app_key generation
      shell: php artisan key:generate
      args: 
	create: /var/www/snipeit



